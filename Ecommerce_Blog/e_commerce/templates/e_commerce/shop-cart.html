{% extends 'base.html' %}
{% load static %}

{% block content %}
	<div class="page-content">
		<!-- inner page banner -->
			<div class="dz-bnr-inr overlay-secondary-dark dz-bnr-inr-sm" style="background-image:url('{% static 'images/background/bg3.jpg' %}');">
				<div class="container">
					<div class="dz-bnr-inr-entry">
						<h1>Cart</h1>
						<nav aria-label="breadcrumb" class="breadcrumb-row">
							<ul class="breadcrumb">
								<li class="breadcrumb-item"><a href="{% url 'e_commerce:index' %}">Accueil</a></li>
								<li class="breadcrumb-item">Cart</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
			<!-- inner page banner End-->

		<!-- contact area -->
		<section class="content-inner shop-account">
			<!-- Product -->
			<div class="container">
				<div class="row mb-5">
					<div class="col-lg-12">
						<div class="table-responsive">
							<table class="table check-tbl">
								<thead>
									<tr>
										<th>Couverture</th>
										<th>Titre</th>
										<th>Prix</th>
										<th>Quantité</th>
										<th>Total</th>
										<th class="text-end">Retirer</th>
									</tr>
								</thead>
								<tbody>
									{% for item in items %}
									<tr data-livre-id="{{ item.livre.id }}">
										<td class="product-item-img">
											<img src="{{ item.livre.couverture.url }}" alt="{{ item.livre.titre }}" width="100">
										</td>
										<td class="product-item-name">{{ item.livre.titre }}</td>
										<td class="product-item-price">{{ item.livre.prix }} FCFA</td>
										<td class="product-item-quantity">
											<div class="quantity btn-quantity style-1 me-3">
												<input type="text" value="{{ item.quantite }}" name="demo_vertical2"/>
											</div>
										</td>
										<td class="product-item-totle">{{ item.total }} FCFA</td>
										<td class="product-item-close">
											<a href="#" class="ti-close remove-from-cart-btn" data-livre-id="{{ item.livre.id }}"></a>
										</td>
									</tr>
									{% empty %}
									<tr><td colspan="6">Votre panier est vide.</td></tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>

				</div>
				<div class="row">
					<div class="col-lg-6">
						<div class="widget">
							<h4 class="widget-title">Total</h4>
							<table class="table-bordered check-tbl m-b25">
								<tbody>
									<tr>
										<td>Prix total</td>
										<td id="prix-total">{{ panier.total_panier }} FCFA</td>
									</tr>
									<tr>
										<td>Frais d'expédition</td>
										<td id="frais-expedition">1500 FCFA</td>
									</tr>
									<tr>
										<td>Total</td>
										<td id="total-general">{{ panier.total_panier|add:1500 }} FCFA</td>
									</tr>
								</tbody>
							</table>

							<div class="form-group m-b25">
								<a href="{% url 'e_commerce:shop-checkout' %}" class="btn btn-primary btnhover" type="button">Passer à la confirmation</a>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Product END -->
		</section>
		<!-- contact area End-->
	</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
	// Fonction pour recalculer le prix total global et le total final
	function updateGlobalTotals() {
		let totalLivres = 0;
		let ligneProduit = $('.product-item-totle');

		// Vérifie si le panier est vide
		if (ligneProduit.length === 0) {
			// Panier vide
			$('td:contains("Prix total")').next().text('0 FCFA');
			$('#frais-expedition').text('0 FCFA');
			$('#total-general').text('0 FCFA');

			// Désactiver le bouton
			let bouton = $('.btn.btn-primary.btnhover');
			bouton.addClass('disabled');
			bouton.css({
				'pointer-events': 'none',
				'opacity': '0.6'
			});
			return;
		}

		// Sinon, recalculer les totaux
		ligneProduit.each(function() {
			const text = $(this).text().replace(' FCFA', '').replace(',', '.');
			const prix = parseInt(text);
			if (!isNaN(prix)) {
				totalLivres += prix;
			}
		});

		// Met à jour le prix total
		$('td:contains("Prix total")').next().text(totalLivres.toFixed(2) + ' FCFA');

		// Définir les frais d’expédition
		let fraisExpedition = 1500;
		$('#frais-expedition').text(fraisExpedition + ' FCFA');

		// Met à jour le total final
		const totalFinal = totalLivres + fraisExpedition;
		$('#total-general').text(totalFinal.toFixed(2) + ' FCFA');

		// Réactiver le bouton si nécessaire
		let bouton = $('.btn.btn-primary.btnhover');
		bouton.removeClass('disabled');
		bouton.css({
			'pointer-events': 'auto',
			'opacity': '1'
		});
	}

	// Capter le clic sur les boutons + ou -
	$('.btn-quantity').on('click', 'button', function() {
		const button = $(this);
		const container = button.closest('tr');  // ligne du tableau
		const livreId = container.data('livre-id');
		const input = container.find('input[name="demo_vertical2"]');
		let quantity = parseInt(input.val());

		// Vérifie si c'est le bouton +
		if (button.hasClass('quantity-right-plus')) {
			quantity++;
		}
		// Ou le bouton - (mais pas moins de 1)
		else if (button.hasClass('quantity-left-minus') && quantity > 1) {
			quantity--;
		}

		// Met à jour l'affichage localement
		input.val(quantity);

		// Requête AJAX vers le backend
		$.ajax({
			url: '/update_quantity/',
			method: 'POST',
			data: {
				'livre_id': livreId,
				'quantite': quantity,
				'csrfmiddlewaretoken': '{{ csrf_token }}'
			},
			success: function(response) {
				if (response.status === 'success') {
					// Mettre à jour le total du livre
					container.find('.product-item-totle').text(response.total_livre + ' FCFA');

					// Mettre à jour le total global
					updateGlobalTotals();
				}
			},
			error: function() {
				alert("Erreur lors de la mise à jour de la quantité.");
			}
		});
	});

	// Si un article est retiré manuellement, on met à jour les totaux
	$('.remove-from-cart-btn').on('click', function(e) {
		e.preventDefault();
		const row = $(this).closest('tr');
		row.remove(); // Supprime la ligne localement
		updateGlobalTotals(); // Recalcule
	});

	// Appeler une première fois au chargement
	updateGlobalTotals();
});
</script>

{% endblock content %}