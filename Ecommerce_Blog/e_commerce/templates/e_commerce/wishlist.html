{% extends 'base.html' %}
{% load static %}

{% block content %}
	<div class="page-content">
		<!-- inner page banner -->
		<div class="dz-bnr-inr overlay-secondary-dark dz-bnr-inr-sm" style="background-image:url('{% static 'images/background/bg3.jpg' %}');">
			<div class="container">
				<div class="dz-bnr-inr-entry">
					<h1>Wishlist</h1>
					<nav aria-label="breadcrumb" class="breadcrumb-row">
						<ul class="breadcrumb">
							<li class="breadcrumb-item"><a href="{% static 'index' %}"> Home</a></li>
							<li class="breadcrumb-item">Wishlist</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
		<!-- inner page banner End-->
		<div class="content-inner-1">
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<div class="table-responsive">
							<table class="table check-tbl">
								<thead>
									<tr>
										<th>Couverture</th>
										<th>Titre</th>
										<th>Prix</th>
										<th>Quantité</th>
										<th>Ajouter au panier</th>
										<th class="text-end">Retirer</th>
									</tr>
								</thead>
								<tbody>
									{% for item in wishlist_items %}
									<tr data-livre-id="{{ item.livre.id }}">
										<td class="product-item-img"><img src="{{ item.livre.couverture.url }}" alt="{{ item.livre.titre }}"></td>
										<td class="product-item-name">{{ item.livre.titre }}</td>
										<td class="product-item-price">{{ item.livre.prix }} FCFA</td>
										<td class="product-item-quantity">
											<div class="quantity btn-quantity style-1 me-3">
												<input type="text" value="1" name="demo_vertical2"/>
											</div>
										</td>
										<td class="product-item-totle"><a href="{% url 'e_commerce:add-to-cart' item.livre.id %}" class="btn btn-primary btnhover add-to-cart-btn" data-livre-id="{{ item.livre.id }}">Add To Cart</a></td>
										<td class="product-item-close">
											<a href="#" class="ti-close remove-from-wishlist-btn" data-livre-id="{{ item.livre.id }}"></a>
										</td>
									</tr>
									{% empty %}
									<tr>
										<td colspan="6">Votre wishlist est vide.</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {

	// Fonction pour mettre à jour le compteur du badge wishlist
	function updateWishlistBadge() {
		let currentCount = parseInt($('#wishlist-count').text());
		if (!isNaN(currentCount) && currentCount > 0) {
			$('#wishlist-count').text(currentCount - 1);
		}
	}

	// Suppression d’un article de la wishlist via AJAX
	$('.remove-from-wishlist-btn').on('click', function(e) {
		e.preventDefault();
		const button = $(this);
		const row = button.closest('tr');
		const livreId = row.data('livre-id');

		$.ajax({
			url: '/remove-from-wishlist/' + livreId + '/',
			method: 'POST',
			data: {
				'csrfmiddlewaretoken': '{{ csrf_token }}'
			},
			success: function(response) {
				// Supprime la ligne du tableau
				row.remove();
				// Met à jour le badge du cœur
				updateWishlistBadge();

				console.log("Livre retiré de la wishlist");
			},
			error: function() {
				alert("Erreur lors de la suppression de l'article de la wishlist.");
			}
		});
	});

	// Ajout d’un livre au panier depuis la wishlist
	$('.add-to-cart-btn').on('click', function(e) {
		e.preventDefault();
		const button = $(this);
		const row = button.closest('tr');
		const livreId = row.data('livre-id');
		const quantite = row.find('.wishlist-quantity').val(); // Récupère la quantité

		$.ajax({
			url: '/add-to-cart/' + livreId + '/',
			method: 'POST',
			data: {
				'livre_id': livreId,
				'quantite': quantite,
				'csrfmiddlewaretoken': '{{ csrf_token }}'
			},
			success: function(response) {
				console.log("Livre ajouté au panier avec quantité :", quantite);
				// Optionnel : affichage d'une notification ou mise à jour visuelle
			},
			error: function() {
				alert("Erreur lors de l’ajout au panier.");
			}
		});
	});
});
</script>
{% endblock content %}